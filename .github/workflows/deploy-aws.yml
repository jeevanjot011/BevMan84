name: Deploy BevMan84 to AWS (NCI MSc Cloud)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS Credentials (Academy Lab)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::815527707232:role/LabRole
        aws-region: us-east-1

    - name: Deploy SQS Queue
      run: |
        aws sqs create-queue --queue-name bevman84-queue || true

    - name: Deploy SNS Topic & Subscribe My Phone
      run: |
        ARN=$(aws sns create-topic --name BevMan84-Notifications --query TopicArn --output text)
        echo "SNS_TOPIC_ARN=$ARN" >> $GITHUB_ENV
        aws sns subscribe \
          --topic-arn $ARN \
          --protocol sms \
          --notification-endpoint +353899671672 \
          --return-subscription-arn || echo "Already subscribed"

    - name: Deploy DynamoDB Table
      run: |
        aws dynamodb create-table \
          --table-name BevMan84-Orders \
          --attribute-definitions AttributeName=order_id,AttributeType=S \
          --key-schema AttributeName=order_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST || echo "Table exists"

    - name: Build & Deploy Lambda from .zip
      run: |
        mkdir package
        pip install --target package boto3
        cp lambda_processor/lambda_function.py package/
        cd package && zip -r9 ../bevman84-lambda.zip .
        cd ..
        aws lambda create-function \
          --function-name BevMan84-OrderProcessor \
          --runtime python3.9 \
          --role arn:aws:iam::815527707232:role/LabRole \
          --handler lambda_function.lambda_handler \
          --zip-file fileb://bevman84-lambda.zip \
          --timeout 30 || \
        aws lambda update-function-code \
          --function-name BevMan84-OrderProcessor \
          --zip-file fileb://bevman84-lambda.zip

    - name: Add SQS Trigger to Lambda
      run: |
        QUEUE_URL=$(aws sqs get-queue-url --queue-name bevman84-queue --query QueueUrl --output text)
        QUEUE_ARN=$(aws sqs get-queue-attributes --queue-url $QUEUE_URL --attribute-names QueueArn --query Attributes.QueueArn --output text)
        aws lambda create-event-source-mapping \
          --function-name BevMan84-OrderProcessor \
          --event-source-arn $QUEUE_ARN \
          --batch-size 1 || echo "Trigger already exists"